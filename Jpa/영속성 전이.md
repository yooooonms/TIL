# ì˜ì†ì„± ì „ì´: CASCADE  

íŠ¹ì • ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ê³  ì‹¶ìœ¼ë©´ ì˜ì†ì„± ì „ì´(transitive persistence) ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.  

ìƒìœ„ ì—”í‹°í‹°ë¥¼ ì €ì¥í•  ë•Œ í•˜ìœ„ ì—”í‹°í‹°ë„ í•¨ê»˜ ì €ì¥í•  ìˆ˜ ìˆë‹¤.  

## ì˜ì†ì„± ì „ì´: ì €ì¥  

```java
@Entity
public class SuperEntity {
    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "superEntity", cascade = CascasdType.PERSIST)
    private List<SubEntity> subEntities = new ArrayList<>();
}

@Entity
public class SubEntity {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne
    private SuperEntity superEntity;
}
```

ìƒìœ„ ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•  ë•Œ ì—°ê´€ëœ í•˜ìœ„ ì—”í‹°í‹°ë“¤ë„ í•¨ê»˜ ì˜ì†í™”í•˜ê³  ì‹¶ìœ¼ë©´ cascade = CascasdType.PERSISTë¡œ ì„¤ì •í•˜ë©´ ëœë‹¤.  

```java
SubEntity subEntity1 = new SubEntity();
SubEntity subEntity2 = new SubEntity();

SuperEntity superEntity = new SuperEntity();
subEntity1.setSuperEntity(superEntity);     // ì—°ê´€ê´€ê³„ ì¶”ê°€
subEntity2.setSuperEntity(superEntity);     // ì—°ê´€ê´€ê³„ ì¶”ê°€
superEntity.getSubEntities().add(subEntity1);
superEntity.getSubEntities().add(subEntity2);

// ìƒìœ„ ì—”í‹°í‹° ì €ì¥, ì—°ê´€ëœ í•˜ìœ„ ì—”í‹°í‹°ë“¤ ì €ì¥
entityManager.persist(superEntity);
```

ìƒìœ„ ì—”í‹°í‹°ë§Œ ì˜ì†í™”í•¨ìœ¼ë¡œì¨ cascade = CascasdType.PERSIST ì„¤ì •ëœ í•˜ìœ„ ì—”í‹°í‹°ê¹Œì§€ í•¨ê»˜ ì˜ì†í™”í•´ ì €ì¥í•œë‹¤.  

ì˜ì†ì„± ì „ì´ëŠ” ì—°ê´€ê´€ê³„ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒê³¼ëŠ” ì•„ë¬´ ê´€ë ¨ì´ ì—†ë‹¤. ë‹¨ì§€ **ì—”í‹°í‹°ë¥¼ ì˜ì†í™”í•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ ê°™ì´ ì˜ì†í™”í•˜ëŠ” í¸ë¦¬í•¨ì„ ì œê³µí•˜ëŠ” ê²ƒ**ì´ë‹¤.  

## ì˜ì†ì„± ì „ì´: ì‚­ì œ  

ì˜ì†ì„± ì „ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ìƒìœ„ ì—”í‹°í‹°ì™€ í•˜ìœ„ ì—”í‹°í‹° ëª¨ë‘ ì œê±°í•˜ë ¤ë©´ ê°ê°ì˜ ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ì”© ì œê±°í•´ì•¼í•œë‹¤.  

cascade = CascasdType.REMOVEë¡œ ì„¤ì •í•˜ê³  ìƒìœ„ ì—”í‹°í‹°ë§Œ ì‚­ì œí•˜ë©´ ì—°ê´€ëœ í•˜ìœ„ ì—”í‹°í‹°ë„ í•¨ê»˜ ì‚­ì œëœë‹¤.  

```java
SuperEntity superEntity = entityManager.find(SuperEntity.class, 1L);
entityManager.remove(superEntity);
```

ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ DELETE SQLì„ 3ë²ˆ ì‹¤í–‰í•˜ê³  ìƒìœ„ ì—”í‹°í‹°ì™€ ì—°ê´€ëœ í•˜ìœ„ ì—”í‹°í‹° ëª¨ë‘ ì‚­ì œí•œë‹¤.  

ì‚­ì œ ìˆœì„œëŠ” ì™¸ë˜ í‚¤ ì œì•½ì¡°ê±´ì„ ê³ ë ¤í•´ì„œ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ë¨¼ì € ì‚­ì œí•˜ê³  ìƒìœ„ ì—”í‹°í‹°ë¥¼ ì‚­ì œí•œë‹¤.  

## CASCADEì˜ ì¢…ë¥˜  

```java
public enum CascadeType {
    ALL,        // ëª¨ë‘ ì ìš©
    PERSIST,    // ì˜ì†
    MERGE,      // ë³‘í•©
    REMOVE,     // ì‚­ì œ
    REFRESH,    // REFRESH
    DETACH      // DETACH
}
```

ì—¬ëŸ¬ ì†ì„±ì„ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  

cascade = {CascadeType.PERSIST, CascadeType.REMOVE}  

PERSIST, REMOVEëŠ” entityManger.persist(), entityManager.remove()ë¥¼ ì‹¤í–‰í•  ë•Œ ë°”ë¡œ ì „ì´ê°€ ë°œìƒí•˜ì§€ ì•Šê³  í”ŒëŸ¬ì‹œë¥¼ í˜¸ì¶œí•  ë•Œ ì „ì´ê°€ ë°œìƒí•œë‹¤.  

## ê³ ì•„ ê°ì²´  

ìƒìœ„ ì—”í‹°í‹°ì™€ ì—°ê´€ê´€ê³„ê°€ ëŠì–´ì§„ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì„ ê³ ì•„ ê°ì²´(ORPHAN) ì œê±°ë¼ê³  í•œë‹¤.  

í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ **ìƒìœ„ ì—”í‹°í‹°ì˜ ì»¬ë ‰ì…˜ì—ì„œ í•˜ìœ„ ì—”í‹°í‹°ì˜ ì°¸ì¡°ë§Œ ì œê±°í•˜ë©´ í•˜ìœ„ ì—”í‹°í‹°ê°€ ìë™ìœ¼ë¡œ ì‚­ì œë˜ê²Œ í•  ìˆ˜ ìˆë‹¤.**  

```java
@Entity
public class SuperEntity {
    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "superEntity", orphanRemoval = true)
    private List<SubEntity> subEntities = new ArrayList<>();
}

@Entity
public class SubEntity {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne
    private SuperEntity superEntity;
}
```

ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ë ¤ë©´ ì»¬ë ‰ì…˜ì— orphanRemoval = trueë¥¼ ì„¤ì •í•˜ë©´ ëœë‹¤.  

```java
SuperEntity superEntity = entityManager.find(SuperEntity.class, 1L);
superEntity.getSubEntities().remove(0); // í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ì»¬ë ‰ì…˜ì—ì„œ ì œê±°
```

ì»¬ë ‰ì…˜ì—ì„œ ì²« ë²ˆì§¸ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ëŠ” ê²ƒì´ë‹¤. orphanRemoval = true ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì»¬ë ‰ì…˜ì—ì„œ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë„ ì‚­ì œëœë‹¤.  

ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í”ŒëŸ¬ì‹œí•  ë•Œ ì ìš©ëœë‹¤.  

ëª¨ë“  ìì‹ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë ¤ë©´ ì»¬ë ‰ì…˜ì„ ë¹„ìš°ë©´ ëœë‹¤. superEntity.getSubEntities().clear();  

**ì°¸ì¡°ê°€ ì œê±°ëœ ì—”í‹°í‹°ëŠ” ë‹¤ë¥¸ ê³³ì—ì„œ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ” ê³ ì•„ ê°ì²´ë¡œ ë³´ê³  ì œê±°í•˜ëŠ¥ ê¸°ëŠ¥ì´ë‹¤.**  

ë”°ë¼ì„œ ì°¸ì¡°í•˜ëŠ” ê³³ì´ í•˜ë‚˜ì¼ ë•Œë§Œ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ì¦‰ íŠ¹ì • ì—”í‹°í‹°ê°€ ê°œì¸ ì†Œìœ í•˜ëŠ” ì—”í‹°í‹°ì—ë§Œ ì´ ê¸°ëŠ¥ì„ ì ìš©í•´ì•¼ í•œë‹¤. ë§Œì•½ ì‚­ì œí•œ ì—”í‹°í‹°ë¥¼ ë‹¤ë¥¸ ê³³ì—ì„œë„ ì°¸ì¡°í•œë‹¤ë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.  

ì´ëŸ° ë¬¸ì œë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´ orphanRemovalì€ @OneToOne, @OneToManyì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  

ê³ ì•„ ê°ì²´ ì œê±° ê¸°ëŠ¥ë„ ìƒìœ„ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë©´ í•˜ìœ„ ì—”í‹°í‹°ë„ ê°™ì´ ì œê±°ëœë‹¤. ì´ëŠ” CascadeType.REMOVEë¥¼ ì„¤ì •í•œ ê²ƒê³¼ ê°™ì€ íš¨ê³¼ë¥¼ ë‚¸ë‹¤.  

## ì˜ì†ì„± ì „ì´ + ê³ ì•„ ê°ì²´, ìƒëª…ì£¼ê¸°  

**CascadeType.ALL + orphanRemoval = true**ë¥¼ ë™ì‹œì— ì‚¬ìš©í•´ ì—”í‹°í‹° ìŠ¤íŠ¸ë¡œ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.  

```java
// í•˜ìœ„ ì—”í‹°í‹° ì €ì¥
SuperEntity superEntity = entityManager.find(SuperEntity.class, 1L);
superEntity.addChild(subEntity1);

// í•˜ìœ„ ì—”í‹°í‹° ì‚­ì œ
SuperEntity superEntity = entityManager.find(SuperEntity.class, 1L);
superEntity.getSubEntities().remove(removeObject);
```

---

#### ğŸ“Œ Reference  

- ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° | ê¹€ì˜í•œ ì €